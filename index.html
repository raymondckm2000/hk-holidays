<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>HK Holidays (2017â€“2026) â€” Calendar + Editor + Theme + 1823 Sync</title>

  <style>
    /* =====================  Theme Variables  ===================== */
    :root{
      color-scheme: light;
      --bg:#f7f9fc; --panel:#ffffff; --text:#102a43; --muted:#486581;
      --accent:#1f6feb; --ok:#2e7d32; --warn:#b26a00; --bad:#c62828;
      --surface:#ffffff; --border:#d6e0ef; --input:#f1f5fb;
      --holiday:#e91e63; --stat:#0aa86f;
    }
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg:#0b1522; --panel:#0f1622; --text:#e9eef6; --muted:#9bb1c9;
      --accent:#2ea3ff; --ok:#2ecc71; --warn:#f7c948; --bad:#e74c3c;
      --surface:#101b2b; --border:#223146; --input:#0b1522;
      --holiday:#ff6ea8; --stat:#49d1a1;
    }

    /* =====================  Base  ===================== */
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial,sans-serif;
      line-height:1.5;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{margin-bottom:16px}
    .wrap{display:grid; gap:16px}
    @media (min-width: 1100px){
      .wrap{grid-template-columns: 1.1fr 1fr}
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px}
    .row label{color:var(--muted); min-width:76px}
    select,input[type="date"],input[type="text"]{
      background:var(--input); color:var(--text);
      border:1px solid var(--border); border-radius:8px; height:36px; padding:6px 10px;
    }
    button,.btn{
      background:var(--accent); color:#fff; border:0; border-radius:8px; padding:8px 14px; cursor:pointer
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--input); border:1px solid var(--border); color:var(--muted)}
    .status{font-size:14px; color:var(--muted)}
    .status strong{color:var(--text)}
    .problems{color:var(--warn)}
    .ok{color:var(--ok)}
    .pill{border:1px solid var(--border); background:var(--input); color:var(--muted); padding:2px 8px; border-radius:999px}

    /* =====================  Calendar  ===================== */
    .cal-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
    .cal-head .title{font-weight:700}
    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:6px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
    }
    .dow{font-size:12px; color:var(--muted); text-align:center; padding:6px 0}
    .cell{
      min-height:92px; background:var(--panel);
      border:1px solid var(--border); border-radius:10px;
      padding:6px; position:relative;
    }
    .cell .d{font-size:12px; color:var(--muted)}
    .cell .hl{margin-top:4px; font-size:12px; line-height:1.25}
    .cell .hl .name{color:var(--holiday)}
    .cell .hl .stat{color:var(--stat); font-weight:600; margin-left:6px; font-size:11px}

    .cell.dim{opacity:.45}

    /* =====================  Editor  ===================== */
    .tblwrap{overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align:top}
    th{position:sticky; top:0; background:var(--panel); z-index:1}
    tr:last-child td{border-bottom:none}
    input[type="checkbox"]{width:16px; height:16px}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .mt8{margin-top:8px}
    .mb8{margin-bottom:8px}
  </style>
</head>

<body>
  <header>
    <h1>HK Holidays (2017â€“2026)</h1>
    <p class="status">
      é è¨­è®€å– <code>hk_holidays_2017_2026.json</code>ï¼ˆåŒç›®éŒ„ï¼‰ï¼›å¯æ‰‹å‹•åŒæ­¥ 1823ã€‚
      <span id="loadInfo" class="badge">åˆå§‹åŒ–ä¸­â€¦</span>
      <span class="pill" id="themeBadge">â€”</span>
    </p>
  </header>

  <div class="panel">
    <div class="row">
      <label for="themeSelect">Theme</label>
      <select id="themeSelect">
        <option value="auto">Autoï¼ˆè·Ÿéš¨ç³»çµ±ï¼‰</option>
        <option value="light">Lightï¼ˆæ—¥é–“/ç™½è‰²ï¼‰</option>
        <option value="dark">Darkï¼ˆå¤œé–“/é»‘è‰²ï¼‰</option>
      </select>
      <button id="btnSync">ğŸ”„ åŒæ­¥ 1823ï¼ˆdata.gov.hkï¼‰</button>
    </div>

    <div class="row">
      <label for="yearSel">å¹´ä»½</label>
      <select id="yearSel"></select>

      <label for="langSel">èªè¨€</label>
      <select id="langSel">
        <option value="zh">ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="both">é›™èª</option>
      </select>

      <label for="typeSel">ç¯©é¸</label>
      <select id="typeSel">
        <option value="all">å…¨éƒ¨å…¬çœ¾å‡æœŸ</option>
        <option value="stat">åªé¡¯ç¤ºå‹å·¥å‡æœŸï¼ˆStatutoryï¼‰</option>
      </select>

      <button id="btnPrev">&lt; ä¸Šå€‹æœˆ</button>
      <span class="badge" id="calTitle">â€”</span>
      <button id="btnNext">ä¸‹å€‹æœˆ &gt;</button>
    </div>

    <div class="row">
      <input id="fileInp" type="file" accept="application/json" hidden />
      <button id="btnLoadLocal">è¼‰å…¥æœ¬åœ° JSONâ€¦</button>
      <div class="actions">
        <button id="btnDlYear">ä¸‹è¼‰æœ¬å¹´ JSON</button>
        <button id="btnDlAll">ä¸‹è¼‰å…¨éƒ¨ JSON</button>
      </div>
      <span id="problemBadge" class="pill">â€”</span>
    </div>
  </div>

  <div class="wrap">
    <!-- =====================  Calendar  ===================== -->
    <section class="panel">
      <div class="cal-head">
        <div class="title" id="calTitle2">â€”</div>
        <div class="muted">é»æ ¼å­å¯åœ¨å³å´åˆ—è¡¨ç·¨è¼¯</div>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </section>

    <!-- =====================  Editor  ===================== -->
    <section class="panel">
      <div class="flex mb8">
        <strong>å¹´åº¦åˆ—è¡¨ / ç·¨è¼¯</strong>
        <span class="pill" id="yearCount">â€”</span>
        <span class="pill" id="statCount">â€”</span>
      </div>

      <div class="actions mb8">
        <label class="flex" style="gap:6px">
          <input type="checkbox" id="chkAll" />
          å…¨é¸
        </label>
        <button id="btnDel">åˆªé™¤å‹¾é¸</button>
        <button id="btnAdd">æ–°å¢å‡æœŸ</button>
      </div>

      <div class="tblwrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:40px"><input type="checkbox" id="chkAll2" title="å…¨é¸" /></th>
              <th style="width:120px">æ—¥æœŸ</th>
              <th>åç¨±ï¼ˆä¸­æ–‡ï¼‰</th>
              <th>åç¨±ï¼ˆEnglishï¼‰</th>
              <th style="width:140px">Statutory</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ===================== Utils & Theme =====================
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const THEME_KEY = 'hk_holidays_theme';

    function getSystemPrefers(){
      return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
    }
    function applyTheme(mode){
      const finalMode = (mode === 'auto') ? getSystemPrefers() : mode;
      document.documentElement.setAttribute('data-theme', finalMode);
      $('#themeBadge').textContent = `ä¸»é¡Œï¼š${finalMode}`;
    }
    function initThemeUI(){
      const sel = $('#themeSelect');
      const saved = localStorage.getItem(THEME_KEY) || 'auto';
      sel.value = saved; applyTheme(saved);
      sel.addEventListener('change', ()=>{
        const v = sel.value;
        localStorage.setItem(THEME_KEY, v);
        applyTheme(v);
      });
      if (window.matchMedia){
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', ()=>{
          if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') applyTheme('auto');
        });
        mq.addListener?.(()=>{ if ((localStorage.getItem(THEME_KEY) || 'auto') === 'auto') applyTheme('auto'); });
      }
    }

    // ===================== Data Model =====================
    /** çµ±ä¸€è³‡æ–™æ ¼å¼ï¼š{ date:"YYYY-MM-DD", name_zh:"", name_en:"", statutory:boolean } */
    let DATA = {};                       // { [year]: Holiday[] }
    const YEARS = Array.from({length: 10}, (_,i)=>2017+i); // 2017â€“2026
    let CUR = { y: new Date().getFullYear(), m: new Date().getMonth() }; // m: 0-11
    const LANG_KEY='hk_lang', TYPE_KEY='hk_type';
    const SELECTED = new Set();

    function setStatus(msg){ $('#loadInfo').textContent = msg; }

    function normalizeIncoming(raw){
      // æ”¯æ´ï¼šé™£åˆ— æˆ– {year:[]}
      let map = {};
      if (Array.isArray(raw)){
        for (const r of raw){
          const y = Number((r.date||'').slice(0,4));
          if (!y) continue;
          (map[y] ||= []).push({
            date: r.date,
            name_zh: r.name_zh || r.zh || r.nameZh || '',
            name_en: r.name_en || r.en || r.nameEn || r.title || r.summary || '',
            statutory: !!(r.statutory ?? r.is_statutory ?? r.isStatutory ?? r.stat)
          });
        }
      } else if (raw && typeof raw === 'object'){
        for (const [y, arr] of Object.entries(raw)){
          map[y] = (arr||[]).map(r => ({
            date: r.date,
            name_zh: r.name_zh || r.zh || r.nameZh || '',
            name_en: r.name_en || r.en || r.nameEn || r.title || r.summary || '',
            statutory: !!(r.statutory ?? r.is_statutory ?? r.isStatutory ?? r.stat)
          }));
        }
      }
      for (const y of Object.keys(map)){ map[y].sort((a,b)=> a.date.localeCompare(b.date)); }
      return map;
    }

    async function loadDefaultJson(){
      try{
        const res = await fetch('./hk_holidays_2017_2026.json', {cache:'no-store'});
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const raw = await res.json();
        DATA = normalizeIncoming(raw);
        setStatus('å·²è¼‰å…¥æœ¬åœ° JSON');
      }catch(e){
        // fallback: minimal sample for 2025
        DATA = {
          2025: [
            {date:'2025-01-01', name_zh:'å…ƒæ—¦', name_en:'The first day of January', statutory:true},
            {date:'2025-10-01', name_zh:'åœ‹æ…¶æ—¥', name_en:'National Day', statutory:true},
            {date:'2025-12-25', name_zh:'è–èª•ç¯€', name_en:'Christmas Day', statutory:false},
          ]
        };
        setStatus('å·²è¼‰å…¥å…§å»ºç¤ºä¾‹ï¼ˆæ‰¾ä¸åˆ°æœ¬åœ° JSONï¼‰');
      }
    }

    // ===================== 1823 Sync (data.gov.hk) =====================
    // ä¸»è¦æŠ“ en.jsonï¼›å˜—è©¦æŠ“ zh.jsonï¼ˆè‹¥ 404/å¤±æ•—å‰‡å¿½ç•¥ï¼‰ï¼Œæœ€å¾ŒæŒ‰æ—¥æœŸåˆä½µé›™èª
    async function sync1823(){
      const enUrl = 'https://www.1823.gov.hk/common/ical/en.json';
      const zhUrl = 'https://www.1823.gov.hk/common/ical/zh.json'; // æœ‰æ™‚å€™ä¸å­˜åœ¨ï¼Œå˜—è©¦å³å¯
      setStatus('åŒæ­¥ä¸­ï¼ˆ1823ï¼‰â€¦');

      try{
        const [enRes, zhRes] = await Promise.allSettled([ fetch(enUrl), fetch(zhUrl) ]);
        if (enRes.status !== 'fulfilled' || !enRes.value.ok){
          throw new Error('ç„¡æ³•å–å¾— 1823 en.json');
        }
        const enArr = await enRes.value.json();

        let zhArr = [];
        if (zhRes.status === 'fulfilled' && zhRes.value.ok){
          try { zhArr = await zhRes.value.json(); }
          catch { zhArr = []; }
        } // å¦å‰‡å°±åªç”¨è‹±æ–‡

        // ä¾æ—¥æœŸåˆä½µé›™èª
        const zhByDate = new Map(zhArr.map(ev => [String(ev.dtstart).slice(0,10), ev]));
        const merged = {};
        for (const ev of enArr){
          const d = String(ev.dtstart).slice(0,10);
          const y = +d.slice(0,4);
          const peer = zhByDate.get(d);
          const name_en = ev.summary || '';
          const name_zh = peer?.summary || peer?.summary_zh || '';
          (merged[y] ??= []).push({ date:d, name_en, name_zh, statutory:false });
        }
        // æ’åº
        for (const y of Object.keys(merged)){ merged[y].sort((a,b)=> a.date.localeCompare(b.date)); }

        DATA = merged;
        CUR.y = Math.min(Math.max(CUR.y, Math.min(...Object.keys(merged).map(Number))), Math.max(...Object.keys(merged).map(Number)));
        setStatus('å·²åŒæ­¥ 1823ï¼ˆä¸€èˆ¬å…¬çœ¾å‡æœŸï¼‰ã€‚å‹å·¥å‡æœŸæ¨™è¨˜å¯æ–¼å³å´å‹¾é¸èª¿æ•´ã€‚');
        renderAll();
      }catch(err){
        console.error(err);
        setStatus('åŒæ­¥ 1823 å¤±æ•—ï¼ˆå¯èƒ½ CORS æˆ–ä¾†æºä¸å¯ç”¨ï¼‰');
      }
    }

    // ===================== Calendar =====================
    const DOW = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

    function renderCalendar(){
      const y = CUR.y, m = CUR.m;
      const title = `${y} å¹´ ${m+1} æœˆ`;
      $('#calTitle').textContent = title;
      $('#calTitle2').textContent = title;

      const grid = $('#calGrid');
      grid.innerHTML = '';
      // header DOW
      for (let i=0;i<7;i++){
        const h = document.createElement('div');
        h.className = 'dow';
        h.textContent = DOW[i];
        grid.appendChild(h);
      }

      // dates
      const first = new Date(y, m, 1);
      const startIdx = first.getDay();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const prevDays = startIdx;
      const prevMonthDays = new Date(y, m, 0).getDate();

      // gather holiday map
      const lang = (localStorage.getItem(LANG_KEY)||'zh');
      const type = (localStorage.getItem(TYPE_KEY)||'all');
      const arr = (DATA[y]||[]);
      const hmap = new Map(arr.map(h=>[h.date,h]));

      const totalCells = 7*6;
      for (let i=0;i<totalCells;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        let d, mm = m, yy = y, dim=false;

        if (i < prevDays){
          d = prevMonthDays - prevDays + 1 + i;
          mm = m-1; if (mm<0){mm=11; yy=y-1;}
          dim = true;
        }else if (i >= prevDays + daysInMonth){
          d = i - (prevDays + daysInMonth) + 1;
          mm = m+1; if (mm>11){mm=0; yy=y+1;}
          dim = true;
        }else{
          d = i - prevDays + 1;
        }

        const dateStr = `${yy}-${String(mm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dEl = document.createElement('div');
        dEl.className = 'd';
        dEl.textContent = String(d);
        cell.appendChild(dEl);

        const h = hmap.get(dateStr);
        if (h && (type==='all' || (type==='stat' && h.statutory))){
          const hl = document.createElement('div');
          hl.className = 'hl';
          const name = (lang==='zh') ? h.name_zh
                    : (lang==='en') ? h.name_en
                    : `${h.name_zh || ''}${(h.name_zh&&h.name_en)?' / ':''}${h.name_en||''}`;
          hl.innerHTML = `<span class="name">${name || '(æœªå‘½å)'}</span>` +
                         (h.statutory ? `<span class="stat">STAT</span>`:'');
          cell.appendChild(hl);
        }

        if (dim) cell.classList.add('dim');
        cell.addEventListener('click', ()=>{ focusOrAdd(dateStr); });
        grid.appendChild(cell);
      }
    }

    // ===================== Editor =====================
    function refreshYearSelectors(){
      const yearSel = $('#yearSel');
      // ç”¨ç¾æœ‰ DATA å¹´ä»½ç”Ÿæˆï¼Œå¦å‰‡ç”¨é è¨­ 2017â€“2026
      const ys = Object.keys(DATA).map(n=>Number(n)).sort((a,b)=>a-b);
      const source = ys.length ? ys : YEARS;
      yearSel.innerHTML = source.map(y=>`<option value="${y}">${y}</option>`).join('');
      if (!source.includes(CUR.y)) CUR.y = source[0];
      yearSel.value = CUR.y;
    }

    function renderEditor(){
      const y = CUR.y;
      const list = (DATA[y]||[]).slice();
      const type = (localStorage.getItem(TYPE_KEY)||'all');
      const tbody = $('#tbody');
      tbody.innerHTML = '';

      let statN=0;
      for (const h of list){
        if (type==='stat' && !h.statutory) continue;
        if (h.statutory) statN++;

        const tr = document.createElement('tr');
        tr.dataset.date = h.date;

        // checkbox
        const tdChk = document.createElement('td');
        const chk = document.createElement('input'); chk.type='checkbox';
        chk.checked = SELECTED.has(h.date);
        chk.addEventListener('change', ()=>{
          if (chk.checked) SELECTED.add(h.date); else SELECTED.delete(h.date);
          syncMasterCheckbox();
        });
        tdChk.appendChild(chk); tr.appendChild(tdChk);

        // date
        const tdDate = document.createElement('td');
        const inDate = document.createElement('input'); inDate.type='date'; inDate.value = h.date;
        inDate.addEventListener('change', ()=>{
          const idx = DATA[y].findIndex(x=>x.date===h.date);
          if (idx>=0){
            const newDate = inDate.value;
            DATA[y][idx].date = newDate;
            SELECTED.delete(h.date);
            h.date = newDate;
            tr.dataset.date = newDate;
            SELECTED.add(newDate);
            sortYear(y);
            renderAll();
          }
        });
        tdDate.appendChild(inDate); tr.appendChild(tdDate);

        // zh
        const tdZh = document.createElement('td');
        const inZh = document.createElement('input'); inZh.type='text'; inZh.className='grow'; inZh.value = h.name_zh||'';
        inZh.addEventListener('input', ()=>{ h.name_zh = inZh.value; checkProblems(); renderCalendar(); });
        tdZh.appendChild(inZh); tr.appendChild(tdZh);

        // en
        const tdEn = document.createElement('td');
        const inEn = document.createElement('input'); inEn.type='text'; inEn.className='grow'; inEn.value = h.name_en||'';
        inEn.addEventListener('input', ()=>{ h.name_en = inEn.value; checkProblems(); renderCalendar(); });
        tdEn.appendChild(inEn); tr.appendChild(tdEn);

        // statutory
        const tdStat = document.createElement('td');
        const inStat = document.createElement('input'); inStat.type='checkbox'; inStat.checked = !!h.statutory;
        inStat.addEventListener('change', ()=>{ h.statutory = inStat.checked; renderCalendar(); updateCounts(); });
        tdStat.appendChild(inStat); tr.appendChild(tdStat);

        tbody.appendChild(tr);
      }

      updateCounts();
      syncMasterCheckbox();
    }

    function sortYear(y){ (DATA[y]||[]).sort((a,b)=> a.date.localeCompare(b.date)); }

    function syncMasterCheckbox(){
      const visibleRows = $$('#tbody tr');
      const allChecked = visibleRows.length && visibleRows.every(tr => SELECTED.has(tr.dataset.date));
      $('#chkAll').checked = allChecked;
      $('#chkAll2').checked = allChecked;
    }

    function setMasterHandlers(){
      for (const id of ['chkAll','chkAll2']){
        $('#'+id).addEventListener('change', (e)=>{
          const checked = e.target.checked;
          for (const tr of $$('#tbody tr')){
            const date = tr.dataset.date;
            const cb = $('input[type="checkbox"]', tr);
            cb.checked = checked;
            if (checked) SELECTED.add(date); else SELECTED.delete(date);
          }
          syncMasterCheckbox();
        });
      }
    }

    function btnHandlers(){
      $('#btnDel').addEventListener('click', ()=>{
        const y = CUR.y;
        DATA[y] = (DATA[y]||[]).filter(h => !SELECTED.has(h.date));
        SELECTED.clear();
        renderAll();
      });

      $('#btnAdd').addEventListener('click', ()=>{
        const y = CUR.y;
        const date = `${y}-${String(CUR.m+1).padStart(2,'0')}-01`;
        (DATA[y] ||= []).push({date, name_zh:'ï¼ˆè«‹è¼¸å…¥ï¼‰', name_en:'(enter name)', statutory:false});
        sortYear(y);
        renderAll();
        focusOrAdd(date);
      });

      $('#btnPrev').addEventListener('click', ()=>{
        CUR.m -= 1; if (CUR.m < 0){ CUR.m=11; CUR.y -= 1; $('#yearSel').value = CUR.y; }
        renderCalendar();
      });
      $('#btnNext').addEventListener('click', ()=>{
        CUR.m += 1; if (CUR.m > 11){ CUR.m=0; CUR.y += 1; $('#yearSel').value = CUR.y; }
        renderCalendar();
      });

      $('#yearSel').addEventListener('change', ()=>{ CUR.y = Number($('#yearSel').value); renderAll(); });
      $('#langSel').addEventListener('change', ()=>{ localStorage.setItem(LANG_KEY, $('#langSel').value); renderCalendar(); renderEditor(); });
      $('#typeSel').addEventListener('change', ()=>{ localStorage.setItem(TYPE_KEY, $('#typeSel').value); renderCalendar(); renderEditor(); });

      $('#btnDlYear').addEventListener('click', ()=>{
        const y = CUR.y;
        downloadJSON({[y]: DATA[y]||[]}, `hk_holidays_${y}.json`);
      });
      $('#btnDlAll').addEventListener('click', ()=>{ downloadJSON(DATA, `hk_holidays_2017_2026.json`); });

      $('#btnLoadLocal').addEventListener('click', ()=> $('#fileInp').click());
      $('#fileInp').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        try{
          const txt = await file.text();
          const json = JSON.parse(txt);
          DATA = normalizeIncoming(json);
          setStatus('å·²è¼‰å…¥æœ¬åœ° JSON');
          renderAll();
        }catch(err){ alert('JSON è§£æå¤±æ•—ï¼š' + err.message); }
        finally{ e.target.value = ''; }
      });

      $('#btnSync').addEventListener('click', sync1823);
    }

    function focusOrAdd(dateStr){
      const tr = $(`#tbody tr[data-date="${dateStr}"]`);
      if (tr){
        tr.scrollIntoView({behavior:'smooth', block:'center'});
        tr.style.outline = `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
        setTimeout(()=>{ tr.style.outline='none'; }, 1000);
      }else{
        const y = Number(dateStr.slice(0,4));
        (DATA[y] ||= []).push({date:dateStr, name_zh:'ï¼ˆè«‹è¼¸å…¥ï¼‰', name_en:'(enter name)', statutory:false});
        sortYear(y);
        CUR.y = y; $('#yearSel').value = y;
        renderAll();
      }
    }

    function updateCounts(){
      const y = CUR.y;
      const arr = (DATA[y]||[]);
      const statN = arr.filter(h=>h.statutory).length;
      $('#yearCount').textContent = `æœ¬å¹´å…± ${arr.length} ç­†`;
      $('#statCount').textContent = `Stat: ${statN}`;
    }

    function checkProblems(){
      let missingZh=0, missingEn=0;
      for (const y of Object.keys(DATA)){
        for (const h of (DATA[y]||[])){
          if (!h.name_zh) missingZh++;
          if (!h.name_en) missingEn++;
        }
      }
      if (missingZh || missingEn){
        $('#problemBadge').textContent = `è³‡æ–™ç¼ºæ¼ï¼šä¸­æ–‡ ${missingZh} / è‹±æ–‡ ${missingEn}`;
        $('#problemBadge').classList.remove('ok');
        $('#problemBadge').classList.add('problems');
      }else{
        $('#problemBadge').textContent = 'è³‡æ–™å®Œæ•´';
        $('#problemBadge').classList.add('ok');
        $('#problemBadge').classList.remove('problems');
      }
    }

    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    function persistUiFromLocal(){
      const lang = localStorage.getItem(LANG_KEY) || 'zh';
      const type = localStorage.getItem(TYPE_KEY) || 'all';
      $('#langSel').value = lang;
      $('#typeSel').value = type;
    }

    function renderAll(){
      refreshYearSelectors();
      persistUiFromLocal();
      updateCounts();
      checkProblems();
      renderCalendar();
      renderEditor();
    }

    // ===================== Boot =====================
    (async function boot(){
      initThemeUI();
      await loadDefaultJson();
      // å¹´ä»½æ ¡æ­£
      const ys = Object.keys(DATA).map(n=>Number(n)).sort((a,b)=>a-b);
      if (ys.length && !ys.includes(CUR.y)) CUR.y = ys[0];
      refreshYearSelectors();
      persistUiFromLocal();
      setMasterHandlers();
      btnHandlers();
      renderAll();
    })();
  </script>
</body>
</html>
